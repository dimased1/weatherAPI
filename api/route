// app/api/weather/route.ts
import { Redis } from "@upstash/redis";
import { NextResponse } from "next/server";

// Самое простое и надёжное подключение — через Vercel Integration
const redis = Redis.fromEnv();

const CITY = "Edinburgh";
const CACHE_KEY = (lang: string) => `weather:gpt:${lang}`;
const CACHE_TTL = 180; // 3 минуты

export const runtime = "edge"; // ← обязательно, иначе будет медленно

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const lang = searchParams.get("lang") === "eng" ? "eng" : "ru";

  const headers = {
    "Cache-Control": "no-store, no-cache, must-revalidate, private",
    "Vercel-CDN-Cache-Control": "no-store",
    "CDN-Cache-Control": "no-store",
  };

  try {
    const [weather, cached] = await Promise.all([
      getWeather(),
      redis.get<{ text: string; ts: number }>(CACHE_KEY(lang)),
    ]);

    let forecast = cached?.text;
    const now = Date.now();
    const needUpdate = !cached || now - (cached.ts || 0) > 120_000;

    if (needUpdate) {
      // Обновляем в фоне — часы этого не ждут!
      updateGptInBackground(weather, lang).catch(console.error);

      if (!forecast) {
        forecast = lang === "eng"
          ? "Beautiful day in Edinburgh!"
          : "Прекрасный день в Эдинбурге!";
      }
    }

    return NextResponse.json({
      forecast,
      city: CITY,
      temp_c: weather.current.temp_c,
      feels_like_c: weather.current.feelslike_c,
      condition: weather.current.condition.text,
      wind_kph: weather.current.wind_kph,
      updated: new Date().toISOString(),
      _ts: Date.now(),
      _cached: !!cached,
    }, { headers });

  } catch (error) {
    console.error("Weather route error:", error);
    return NextResponse.json({
      forecast: lang === "eng"
        ? "Good evening from Edinburgh!"
        : "Добрый вечер из Эдинбурга!",
      city: CITY,
      updated: new Date().toISOString(),
      error: "offline",
    }, { status: 200, headers });
  }
}

// Фоновая задача — не блокирует ответ
async function updateGptInBackground(weather: any, lang: string) {
  const text = await getGptForecast(weather, lang);
  await redis.set(CACHE_KEY(lang), { text, ts: Date.now() }, { ex: CACHE_TTL + 60 });
}

// Твои функции без изменений
async function getWeather() {
  const url = `https://api.weatherapi.com/v1/forecast.json?key=\( {process.env.WEATHER_KEY}&q= \){CITY}&days=1&aqi=no&alerts=no`;
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) return { current: { temp_c: 10, feelslike_c: 8, condition: { text: "облачно" }, wind_kph: 15 }};
  const d = await r.json();
  return { current: d.current, forecastday: d.forecast.forecastday[0] };
}

async function getGptForecast(data: any, lang = "ru") {
  const prompt = lang === "eng" ?
`Короткий тёплый прогноз на основе этого JSON (только факты из JSON):

${JSON.stringify(data)}

Просто дай прогноз на английском: приветствие по времени суток, температура, ощущается, ветер, осадки, что надеть. 2–3 предложения, очень дружелюбно. Без вопросов и без JSON в ответе.`
:
`Короткий тёплый прогноз на основе этого JSON:

${JSON.stringify(data)}

Дай прогноз на русском: приветствие по времени суток, температура и ощущается, осадки, ветер, совет по одежде. 2–3 абзаца, максимум 70 слов, очень по-доброму. Без вопросов и без упоминания JSON.`;

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        temperature: 0.7,
        max_tokens: 300,
        messages: [
          { role: "system", content: "Ты отвечаешь ТОЛЬКО текстом прогноза погоды." },
          { role: "user", content: prompt }
        ],
      }),
    });

    if (!response.ok) throw new Error("OpenAI error");

    const json = await response.json();
    return json.choices?.[0]?.message?.content?.trim() || "Приятная погода!";

  } catch (e) {
    return lang === "eng"
      ? "Lovely weather in Edinburgh!"
      : "В Эдинбурге сегодня хорошая погода!";
  }
}
