// /api/weather.js
import OpenAI from "openai";

const CITY = "Edinburgh";
const WEATHER_API_KEY = process.env.WEATHER_API_KEY;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

export default async function handler(req, res) {
  // Разрешаем CORS (если будешь вызывать с фронтенда)
  res.setHeader("Access-Control-Allow-Origin", "*");

  const lang = req.query.lang || "ru";
  if (lang !== "ru") {
    return res.status(400).json({ error: "Поддерживается только русский язык (lang=ru)" });
  }

  try {
    if (!WEATHER_API_KEY || !OPENAI_API_KEY) {
      return res.status(500).json({ error: "Не настроены API-ключи на сервере" });
    }

    // 1. Получаем погоду
    const weatherUrl = `https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(
      CITY
    )}&days=1&aqi=no&alerts=no`;

    const weatherRes = await fetch(weatherUrl);
    if (!weatherRes.ok) {
      const err = await weatherRes.text();
      throw new Error(`WeatherAPI: ${weatherRes.status} — ${err}`);
    }
    const weatherJson = await weatherRes.json();

    const location = weatherJson.location;
    const current = weatherJson.current;
    const dayForecast = weatherJson.forecast.forecastday[0].day;

    const weatherData = {
      location,
      current,
      day: dayForecast,
    };

    // 2. Генерируем текст через OpenAI
    const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

    const prompt = `
Сегодня ${new Date().toLocaleDateString("ru-RU", {
  weekday: "long",
  day: "numeric",
  month: "long",
})}.

Город: ${location.name}, ${location.country}.
Сейчас: ${current.temp_c}°C, ${current.condition.text}, ветер ${current.wind_kph} км/ч.
Дневной прогноз: макс. ${dayForecast.maxtemp_c}°C, мин. ${dayForecast.mintemp_c}°C, осадки ${dayForecast.daily_chance_of_rain}%.

Напиши короткий, тёплый и дружелюбный прогноз на сегодня по-русски (максимум 120 слов).
Начни с приветствия по времени суток. Дай совет по одежде и небольшой совет на день.
Пиши связно, раздели на 2-3 абзаца. Без смайликов.
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",           // работает 100%, быстро и дёшево
      messages: [
        { role: "system", content: "Ты заботливый и дружелюбный погодный помощник." },
        { role: "user", content: prompt },
      ],
      max_tokens: 350,
      temperature: 0.7,
    });

    const forecast = completion.choices[0].message.content.trim();

    // 3. Ответ
    return res.status(200).json({
      city: location.name,
      country: location.country,
      forecast,
      generatedAt: new Date().toLocaleString("ru-RU"),
    });
  } catch (err) {
    console.error("Ошибка в /api/weather:", err);
    return res.status(500).json({
      error: "Не удалось получить прогноз",
      details: err.message,
    });
  }
}
